<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Risco para Desportos de Natureza</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK (using modern versions) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      window.firebase = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { transition: all 0.2s; } .btn:hover { transform: translateY(-2px); }
        .btn-primary { background-color: #3b82f6; color: white; } .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; } .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; } .btn-success:hover { background-color: #16a34a; }
        .risk-matrix-container { display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; align-items: center; }
        .risk-matrix { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; border: 1px solid #d1d5db; border-radius: 0.25rem; padding: 2px; width: 150px; }
        .matrix-cell { aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 500; color: white; cursor: pointer; border-radius: 0.125rem; }
        .matrix-cell.selected { border: 2px solid #ffffff; box-shadow: 0 0 0 2px #3b82f6; transform: scale(1.1); z-index: 5; }
        .axis-label { writing-mode: vertical-rl; transform: rotate(180deg); text-align: center; font-size: 0.75rem; font-weight: 600; color: #4b5563; }
        .consequence-labels { grid-column: 2; display: grid; grid-template-columns: repeat(5, 1fr); text-align: center; font-size: 0.75rem; font-weight: 600; color: #4b5563; }
        .risk-low { background-color: #22c55e; } .risk-moderate { background-color: #facc15; }
        .risk-high { background-color: #f97316; } .risk-extreme { background-color: #ef4444; }
        .extreme-risk-alert-row { border: 2px solid #ef4444 !important; background-color: #fef2f2; }
        .extreme-risk-icon { color: #ef4444; display: none; } .extreme-risk-alert-row .extreme-risk-icon { display: inline-block; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        #material-emergencia-container {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }
        @media (min-width: 640px) { #material-emergencia-container { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { #material-emergencia-container { grid-template-columns: repeat(3, 1fr); } }
        @media print { body * { visibility: hidden; } .print-section, .print-section * { visibility: visible; } .print-section { position: absolute; left: 0; top: 0; width: 100%; } .no-print { display: none; } }
        #loading-spinner { border-top-color: #3498db; }
        
        /* Estilo para a notificação */
        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }
        #notification.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -10px);
        }
        #notification.bg-red-500 { background-color: #ef4444; }
        #notification.bg-blue-500 { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-alert-triangle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </symbol>
    </svg>

    <div id="app-container" class="container mx-auto p-4 md:p-8" style="display: none;">
        <header class="text-center mb-8 no-print">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Modelo de análise do risco para a prevenção de acidentes em desportos de natureza</h1>
            <p class="text-md text-gray-600 mt-2">Modelo de (Carlos Mata; Catarina Pereira e Luís Carvalhinho 2023)</p>
        </header>

        <div class="mb-6 border-b border-gray-200 no-print">
            <nav class="flex flex-wrap justify-center space-x-4" aria-label="Tabs">
                <button id="tab-fase1" class="tab-button active py-3 px-4 text-sm font-medium text-center text-gray-500 border-b-2">Fase 1: Análise Preliminar</button>
                <button id="tab-fase2" class="tab-button py-3 px-4 text-sm font-medium text-center text-gray-500 border-b-2">Fase 2: Avaliação CMAR</button>
                <button id="tab-fase3" class="tab-button py-3 px-4 text-sm font-medium text-center text-gray-500 border-b-2">Painel de Controlo</button>
            </nav>
        </div>

        <main>
            <div id="fase1" class="tab-content active print-section"><!-- Content Filled by JS --></div>
            <div id="fase2" class="tab-content print-section"><!-- Content Filled by JS --></div>
            <div id="fase3" class="tab-content"><!-- Content Filled by JS --></div>
        </main>
    </div>
    
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col justify-center items-center">
        <div id="loading-spinner" class="w-12 h-12 border-4 border-gray-200 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-600">A carregar aplicação...</p>
    </div>

    <!-- Elemento para as notificações -->
    <div id="notification"></div>

    <script type="module">
        // App logic wrapped in a function to be called after the DOM is ready
        function main() {
            try {
                const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } = window.firebase;

                // ===================================================================================
                // IMPORTANTE: CONFIGURAÇÃO DO FIREBASE
                // ===================================================================================
                const GITHUB_FIREBASE_CONFIG = {
                    apiKey: "AIzaSyCcpSTYkV5SumpC28J9NwFHmmQKW6Dp9vo",
                    authDomain: "modelo-analise-de-risco.firebaseapp.com",
                    projectId: "modelo-analise-de-risco",
                    storageBucket: "modelo-analise-de-risco.appspot.com",
                    messagingSenderId: "808630343356",
                    appId: "1:808630343356:web:f7c54d8fd7cb4249a3a2b9",
                    measurementId: "G-PPDK22QY2N"
                };
                
                const finalFirebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : GITHUB_FIREBASE_CONFIG;
                
                const appId_str = typeof __app_id !== 'undefined' ? __app_id : 'github-hosted-app';
                
                if (typeof __firebase_config === 'undefined' && finalFirebaseConfig.apiKey.includes("COLE_A_SUA")) {
                    document.body.innerHTML = `<div class="p-8 text-center bg-red-100 text-red-800"><h1>Erro de Configuração</h1><p>As chaves de configuração do Firebase não foram preenchidas no ficheiro index.html. Siga as instruções no código para configurar a sua aplicação.</p></div>`;
                    throw new Error("A configuração do Firebase não foi definida.");
                }

                const app = initializeApp(finalFirebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                const medidasSeguranca = ["Políticas e programas de treino em deportos de natureza.", "Tomada de decisão em domínios complexos, dinâmicos e de alto risco.", "Investigação profunda dos riscos no contexto de desporto natureza.", "Código de conduta para o setor.", "Prevenção apoiada na abordagem de experiências do praticante.", "Utilização de matriz de risco para obtenção de níveis gerais por praticante.", "Bom aquecimento.", "Treino teórico e prático de procedimentos de segurança, incluindo primeiros socorros e técnicas de escalada de resgate.", "Registo das ocorrências de acidentes.", "Fiscalização das licenças e seguros.", "Reavaliações regulares das capacidades do instrutor para a gestão do risco primeiros socorros e desenvolvimento de 'habilidades sociais'.", "Compreender melhor a relação entre a perceção e a exposição ao risco.", "Perceber a competência técnica para escalar em segurança.", "Mais investigação sobre o Risco em todas modalidades de desporto natureza e em vários países.", "Gestão por parte das autoridades locais, governamentais e reguladoras.", "Desenvolver sistemas padronizados para relatórios de acidentes e incidente.", "Banco de dados universal de acidentes/incidentes em atividades de natureza.", "Desenvolvimento de taxonomias do sistema de falhas e erro humano.", "Educar o praticante para medidas preventivas eficazes.", "Comunicação do risco através de diferentes canais, como redes sociais, brochuras ou sistemas interativos de interpretação.", "A avaliação de vídeo como técnica de análise do risco na recreação ao ar livre.", "Investigação em fatores de análise do risco, como sexo, idade, comportamentos, ou nível de especialização.", "Discussão entre técnicos para definir estratégias de redução dos riscos.", "Identificar decisões erradas ou falta de habilidade por parte dos instrutores.", "Melhorar os formulários de consentimento e informações dos participantes.", "Comunicar os riscos associados aos participantes.", "Os técnicos devem ter o poder de abortar as atividades ou impedir os participantes de participarem.", "Desenvolver estratégias de gestão do risco mais adequadas em torno da presença de terreno inseguro ou clima adverso durante as atividades."];
                const materialEmergencia = { "Material Geral": ["Luvas", "Soro fisiológico", "Spray antisséptico", "Pensos rápidos", "Tesoura", "Fita adesiva (pequena)", "Fita adesiva de 5cm", "Pinça", "Gaze", "Lençol isotérmico", "Saco de frio", "Saco de calor", "Saco para lixo"], "Equipamentos de medição": ["Medidor pressão arterial", "Oxímetro (SPo2)", "Medidor de glicémia", "Lanterna pupilas", "Termómetro"], "Respiratório": ["Máscara pocket (PCR)", "Conjunto tubos orofaríngeos"], "Queimaduras": ["Gel para queimaduras", "Gaze gorda", "Lençol para queimados", "Protetor solar"], "Hemorragias": ["Garrote", "Ligadura Israelita", "Caneta demográfica (permite escrever na pele)", "Cinto Pélvico (em substituição, lençol térmico)", "Ligaduras", "Compressas esterilizadas", "Torniquete", "Compressas hemostáticas", "Pensos de união (suturas)"], "Trauma": ["Colar cervical (ajustável)", "Talas (vários tamanhos)", "Ligaduras", "Corda 10m"], "Medicação": ["Paracetamol", "Açúcar ou gel açucarado", "Anti-histamínico (ex.: cetirizina)", "Repelente de insetos"], "Comunicações": ["Telemóvel", "Walkie talkie portátil", "GPS", "Painel solar"], "Kit de sobrevivência": ["Apito", "Lanterna (frontal)", "Faca", "Pastilha para purificação de água", "Isqueiro de pedras"] };
                const riskData = { "Humanos": [{ id: "H1", text: "Nível de experiência na modalidade (Técnico)" }, { id: "H2", text: "Competências de resgate e socorrismo (Técnico)" }, { id: "H3", text: "Informações de segurança aos praticantes (Técnico)" }, { id: "H4", text: "Rácio técnico/praticantes" }, { id: "H5", text: "Utilização de procedimentos de segurança (Técnico)" }, { id: "H6", text: "Capacidade de liderança e decisão (Técnico)" }, { id: "H7", text: "Competências de planeamento e gestão (Técnico)" }, { id: "H8", text: "Conhecimento dos locais e perigos (Técnico)" }, { id: "H9", text: "Competências de intervenção pedagógica (Técnico)" }, { id: "H10", text: "Condição física (Técnico)" }, { id: "H11", text: "Vestuário e calçado adequado (Praticante)" }, { id: "H12", text: "Nível de experiência (Praticante)" }, { id: "H13", text: "Conduta de segurança (Praticante)" }], "Ambiental": [{ id: "A1", text: "Temperatura" }, { id: "A2", text: "Condições adversas extremas (vento, chuva, etc)" }, { id: "A3", text: "Estado de conservação do meio" }, { id: "A4", text: "Acesso a veículos de socorro" }, { id: "A5", text: "Comunicações (rede telemóvel, rádios)" }, { id: "A6", text: "Dificuldade do percurso" }, { id: "A7", text: "Duração do percurso" }, { id: "A8", text: "Nível da água (Canyoning)" }, { id: "A9", text: "Qualidade da rocha (Canyoning/Escalada)" }, { id: "A10", text: "Exposição solar (Escalada)" }], "Materiais e Equipamentos": [{ id: "M1", text: "Utilização de materiais certificados" }, { id: "M2", text: "Manutenção dos materiais" }, { id: "M3", text: "Características dos materiais" }, { id: "M4", text: "Manipulação dos materiais" }, { id: "M5", text: "Adequação dos materiais aos praticantes" }, { id: "M6", text: "Estado dos equipamentos fixos (Escalada)" }, { id: "M7", text: "Performance dos materiais" }], "Segurança e Emergência": [{ id: "S1", text: "Equipamento para comunicações" }, { id: "S2", text: "Kit primeiros socorros" }, { id: "S3", text: "Equipamento para salvamento e resgate" }, { id: "S4", text: "Kit sobrevivência" }, { id: "S5", "text": "EPI e EPC adequados" }] };
                let userId = null, allAssessments = [], filteredAssessments = [], analysisChart = null, assessmentSummaryChart = null;

                // Trata da autenticação para ambos os ambientes (Canvas e standalone)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        loadAssessments();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Auth Error:", e);
                        }
                    }
                });

                const showNotification = (message, isError = false) => {
                    const notification = document.getElementById('notification');
                    notification.textContent = message;
                    notification.className = 'show ' + (isError ? 'bg-red-500' : 'bg-blue-500');
                    setTimeout(() => notification.classList.remove('show'), 3000);
                };
                
                // --- LÓGICA DA MATRIZ CORRIGIDA (BASEADA NO SCORE CONFORME FEEDBACK) ---
                const getRiskClassification = (score) => {
                    score = parseInt(score);
                    if (score >= 15) return { level: "Risco Extremo", colorClass: "risk-extreme", recommendation: "Cancelar", treatment: "Deve cancelar a atividade se não conseguir corrigir o risco." };
                    if (score >= 8) return { level: "Risco Elevado", colorClass: "risk-high", recommendation: "Alerta", treatment: "Deve estar em alerta e tentar corrigir os riscos." };
                    if (score >= 4) return { level: "Risco Moderado", colorClass: "risk-moderate", recommendation: "Ponderada", treatment: "Não compromete, mas requer gestão ponderada." };
                    return { level: "Risco Baixo", colorClass: "risk-low", recommendation: "Recomendada", treatment: "Não compromete a atividade." };
                };
                
                const createRiskMatrix = (factorId) => { 
                    let h = `<div class="risk-matrix-container"><div class="axis-label">Probabilidade</div><div class="risk-matrix" data-factor-id="${factorId}">`; 
                    for (let p = 5; p >= 1; p--) {
                        for (let c = 1; c <= 5; c++) { 
                            const s = p * c;
                            const cl = getRiskClassification(s); // Cor da célula baseada no score
                            h += `<div class="matrix-cell ${cl.colorClass} ${p===1&&c===1?'selected':''}" data-prob="${p}" data-cons="${c}" data-score="${s}" title="P:${p},C:${c},S:${s}">${s}</div>`; 
                        }
                    } 
                    h += `</div><div></div><div class="consequence-labels">${[...Array(5).keys()].map(i=>`<span>${i+1}</span>`).join('')}</div><div></div><div class="text-center text-xs font-semibold text-gray-600 col-span-5">Consequência</div></div>`; 
                    return h; 
                };
                
                const changeTab = (tabId) => {
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    document.getElementById('tab-' + tabId).classList.add('active');
                };

                const renderFase1 = () => {
                    const container = document.getElementById('fase1');
                    container.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Informações Gerais</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="companyName" class="block text-sm font-medium text-gray-700">Nome da Empresa/Instituição</label><input type="text" id="companyName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                                <div><label for="preliminaryDate" class="block text-sm font-medium text-gray-700">Data da Análise Preliminar</label><input type="date" id="preliminaryDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                                <div><label for="technicianName" class="block text-sm font-medium text-gray-700">Nome do Técnico</label><input type="text" id="technicianName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                                <div><label for="technicianAge" class="block text-sm font-medium text-gray-700">Idade</label><input type="number" id="technicianAge" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Verificação das Medidas de Segurança</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm" id="medidas-seguranca-container"></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Material e Equipamento de Segurança e Emergência</h2>
                            <div id="material-emergencia-container"></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md no-print">
                            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Ações da Fase 1</h2>
                            <div class="flex flex-wrap gap-4">
                                <button id="save-fase1-btn" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Guardar Registo</button>
                                <button id="export-fase1-pdf-btn" class="btn btn-secondary font-bold py-2 px-4 rounded-lg">Exportar (PDF)</button>
                                <button id="export-fase1-excel-btn" class="btn btn-success font-bold py-2 px-4 rounded-lg">Exportar (Excel)</button>
                            </div>
                        </div>`;
                    
                    const medidasContainer = document.getElementById('medidas-seguranca-container');
                    medidasSeguranca.forEach((m, i) => {
                        const l = document.createElement('label');
                        l.className = 'flex items-start space-x-3 p-2 rounded-md hover:bg-gray-50';
                        l.innerHTML = `<input type="checkbox" data-measure-text="${m}" class="h-4 w-4 text-blue-600 rounded mt-1"><span class="flex-1">${i + 1}. ${m}</span>`;
                        medidasContainer.appendChild(l);
                    });

                    const materialContainer = document.getElementById('material-emergencia-container');
                    for (const cat in materialEmergencia) {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-50 p-4 rounded-lg';
                        div.innerHTML = `<h3 class="font-semibold text-md">${cat}</h3><div class="mt-2 space-y-1">${materialEmergencia[cat].map(item => `<label class="flex items-center space-x-2 py-1"><input type="checkbox" data-material-text="${item}" data-material-category="${cat}" class="h-4 w-4 text-blue-600 rounded"><span class="text-sm">${item}</span></label>`).join('')}</div>`;
                        materialContainer.appendChild(div);
                    }
                    document.getElementById('preliminaryDate').valueAsDate = new Date();
                    document.getElementById('export-fase1-pdf-btn').addEventListener('click', () => exportPdf('#fase1'));
                    document.getElementById('export-fase1-excel-btn').addEventListener('click', exportPhase1Excel);
                    document.getElementById('save-fase1-btn').addEventListener('click', saveAssessment);
                };
                
                const renderFase2 = () => {
                    const container = document.getElementById('fase2');
                    container.innerHTML = `
                        <div class="card p-6 mb-8">
                            <h2 class="text-2xl font-bold mb-4 text-gray-700 border-b pb-2">Informações da Avaliação</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="evaluatorName" class="block text-sm font-medium">Nome do Avaliador</label><input type="text" id="evaluatorName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                                <div><label for="evalDate" class="block text-sm font-medium">Data</label><input type="date" id="evalDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                                <div><label for="location" class="block text-sm font-medium">Local da Atividade</label><input type="text" id="location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                                <div><label for="activity" class="block text-sm font-medium">Atividade</label><input type="text" id="activity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                            </div>
                        </div>
                        <div id="risk-factors-container"></div>
                        <div class="card p-6 mt-8">
                            <h2 class="text-2xl font-bold mb-4 text-gray-700 border-b pb-2">Resultados e Ações</h2>
                            <div class="flex flex-wrap gap-4 mb-6 no-print">
                                <button id="calculate-btn-assessment" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Calcular Resultados</button>
                                <button id="save-assessment-btn" class="btn btn-secondary font-bold py-2 px-4 rounded-lg">Guardar Avaliação</button>
                                <button id="export-pdf-btn" class="btn btn-secondary font-bold py-2 px-4 rounded-lg">Exportar (PDF)</button>
                                <button id="export-excel-btn" class="btn btn-success font-bold py-2 px-4 rounded-lg">Exportar (Excel)</button>
                                <button id="clear-btn" class="btn btn-danger font-bold py-2 px-4 rounded-lg">Limpar</button>
                            </div>
                            <div id="results-content-assessment" class="hidden">
                                <div id="extreme-risk-summary-container" class="hidden mb-8"></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div><h3 class="text-xl font-semibold mb-3">Avaliação Geral</h3><div id="overall-result"></div></div>
                                    <div><h3 class="text-xl font-semibold mb-3">Resumo por Dimensão</h3><div class="h-64"><canvas id="assessment-summary-chart"></canvas></div></div>
                                </div>
                            </div>
                        </div>`;
                    const riskContainer = document.getElementById('risk-factors-container');
                    for(const dim in riskData){
                        const card = document.createElement('div'); card.className='card mb-8';
                        card.innerHTML = `<h2 class="text-2xl font-bold text-slate-900 bg-slate-200 p-4 border-b">Dimensão: ${dim}</h2>`;
                        const wrapper = document.createElement('div'); wrapper.className='p-6 space-y-6';
                        riskData[dim].forEach((f, i) => {
                            const row = document.createElement('div');
                            row.id = `row-${f.id}`; 
                            row.dataset.score = '1'; 
                            row.dataset.prob = '1';
                            row.dataset.dimension = dim;
                            row.className = 'grid grid-cols-1 md:grid-cols-3 gap-6 items-center p-4 rounded-lg border';
                            const d = getRiskClassification(1);
                            row.innerHTML = `<div class="md:col-span-1"><p class="font-semibold flex items-start gap-2"><svg class="w-5 h-5 extreme-risk-icon flex-shrink-0 mt-1"><use xlink:href="#icon-alert-triangle"></use></svg><span class="font-bold text-gray-500 w-12 flex-shrink-0">FR${i+1}:</span><span id="text-${f.id}">${f.text}</span></p></div><div class="md:col-span-1 flex justify-center">${createRiskMatrix(f.id)}</div><div class="md:col-span-1 flex flex-col items-center text-center"><div class="risk-score-badge p-2 rounded-full w-12 h-12 flex items-center justify-center text-white font-bold text-lg bg-green-500"><span id="score-${f.id}">1</span></div><span id="class-${f.id}" class="text-lg font-bold mt-2">${d.level}</span><div class="text-xs text-left mt-2 p-2 bg-gray-50 rounded-md border w-full"><p><strong>Recomendação:</strong> <span id="rec-${f.id}">${d.recommendation}</span></p><p class="mt-1"><strong>Tratamento:</strong> <span id="treat-${f.id}">${d.treatment}</span></p></div></div>`;
                            wrapper.appendChild(row);
                        });
                        card.appendChild(wrapper);
                        riskContainer.appendChild(card);
                    }
                    document.querySelectorAll('.risk-matrix').forEach(m => m.addEventListener('click', (e) => {
                        if(e.target.classList.contains('matrix-cell')){
                            const cell = e.target, 
                                  factorId = m.dataset.factorId, 
                                  score = cell.dataset.score,
                                  prob = cell.dataset.prob;
                            const row = document.getElementById(`row-${factorId}`);
                            row.dataset.score = score;
                            row.dataset.prob = prob;
                            updateFactorDisplay(factorId, score);
                            m.querySelector('.selected')?.classList.remove('selected');
                            cell.classList.add('selected');
                        }
                    }));
                    document.getElementById('evalDate').valueAsDate = new Date();
                    document.getElementById('calculate-btn-assessment').addEventListener('click', calculateAndShowResults);
                    document.getElementById('save-assessment-btn').addEventListener('click', saveAssessment);
                    document.getElementById('clear-btn').addEventListener('click', clearForm);
                    document.getElementById('export-pdf-btn').addEventListener('click', () => exportPdf('#fase2'));
                    document.getElementById('export-excel-btn').addEventListener('click', exportSingleExcel);
                };
                
                const renderFase3 = () => {
                    const container = document.getElementById('fase3');
                    container.innerHTML = `
                        <div class="card p-6 mb-8">
                            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Filtros de Análise</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <input type="date" id="filter-start-date" class="rounded-md border-gray-300 shadow-sm">
                                <input type="date" id="filter-end-date" class="rounded-md border-gray-300 shadow-sm">
                                <input type="text" id="filter-location" placeholder="Filtrar por local..." class="rounded-md border-gray-300 shadow-sm">
                                <input type="text" id="filter-evaluator" placeholder="Filtrar por avaliador..." class="rounded-md border-gray-300 shadow-sm">
                            </div>
                            <button id="apply-filters-btn" class="mt-4 btn btn-primary py-2 px-4 rounded-lg">Aplicar Filtros</button>
                            <button id="export-filtered-excel-btn" class="mt-4 btn btn-success py-2 px-4 rounded-lg">Exportar Filtrados (Excel)</button>
                        </div>
                        <div class="card p-6 mb-8">
                            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Análise Gráfica Agregada</h2>
                            <div class="h-80"><canvas id="analysis-chart"></canvas></div>
                        </div>
                        <div class="card p-6">
                            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Histórico de Avaliações</h2>
                            <div id="assessment-history-list" class="space-y-4"><p>A carregar...</p></div>
                        </div>`;
                    document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
                    document.getElementById('export-filtered-excel-btn').addEventListener('click', exportFilteredExcel);
                };

                const updateFactorDisplay = (id, score) => {
                    const el = (s) => document.getElementById(s + id);
                    const cl = getRiskClassification(score);
                    el('score-').textContent = score; 
                    el('class-').textContent = cl.level;
                    el('rec-').textContent = cl.recommendation; 
                    el('treat-').textContent = cl.treatment;
                    const badge = el('score-').parentElement;
                    badge.className = `risk-score-badge p-2 rounded-full w-12 h-12 flex items-center justify-center text-white font-bold text-lg ${cl.colorClass.replace('risk-','bg-')}`;
                    el('row-').classList.toggle('extreme-risk-alert-row', cl.level === "Risco Extremo");
                };

                const calculateAndShowResults = () => {
                    let highestScore = 0; 
                    const eF=[], dRC={};
                    Object.keys(riskData).forEach(d => dRC[d] = {"Risco Baixo":0,"Risco Moderado":0,"Risco Elevado":0,"Risco Extremo":0});
                    
                    document.querySelectorAll('#fase2 [id^="row-"]').forEach(r => {
                        const score = parseInt(r.dataset.score);
                        const cl = getRiskClassification(score);
                        
                        if(score > highestScore) highestScore = score; 
                        
                        dRC[r.dataset.dimension][cl.level]++;
                        if(cl.level==="Risco Extremo") eF.push(`${r.querySelector('.font-bold.text-gray-500').textContent} ${r.querySelector('[id^="text-"]').textContent}`);
                    });
                    const extremeContainer = document.getElementById('extreme-risk-summary-container');
                    if(eF.length > 0) {
                        extremeContainer.innerHTML = `<h3 class="text-xl font-bold text-red-600 flex items-center gap-2"><svg class="w-6 h-6"><use xlink:href="#icon-alert-triangle"></use></svg>Alerta de Risco Extremo</h3><div class="mt-2 p-4 bg-red-50 border rounded-lg text-red-800"><p class="font-bold mb-2">Recomendação Final: Cancelar</p><ul>${eF.map(t=>`<li class="mt-1 ml-4 list-disc">${t}</li>`).join('')}</ul></div>`;
                        extremeContainer.classList.remove('hidden');
                    } else {
                        extremeContainer.classList.add('hidden');
                    }
                    const oC = getRiskClassification(highestScore);
                    const oR = document.getElementById('overall-result');
                    oR.innerHTML = `<p class="text-4xl font-bold">${oC.level}</p><div class="mt-4 text-left p-4 bg-gray-100 rounded-lg text-gray-800"><p><strong>Recomendação:</strong> <span>${oC.recommendation}</span></p><p class="mt-2"><strong>Tratamento:</strong> <span>${oC.treatment}</span></p></div>`;
                    oR.className = `p-6 rounded-lg text-center flex flex-col justify-center h-full ${oC.colorClass.replace('risk-','bg-')} text-white`;
                    document.getElementById('results-content-assessment').classList.remove('hidden');
                    updateAssessmentSummaryChart(dRC);
                };
                
                async function saveAssessment() {
                    if(!userId) { showNotification("Erro: Utilizador não autenticado.", true); return; }
                    const fase1Data = { companyName: document.getElementById('companyName').value.trim(), preliminaryDate: document.getElementById('preliminaryDate').value, technicianName: document.getElementById('technicianName').value.trim(), technicianAge: document.getElementById('technicianAge').value, medidasChecked: Array.from(document.querySelectorAll('#fase1 input[data-measure-text]:checked')).map(cb => cb.dataset.measureText), materialChecked: Array.from(document.querySelectorAll('#fase1 input[data-material-text]:checked')).map(cb => ({ category: cb.dataset.materialCategory, item: cb.dataset.materialText })) };
                    const fase2Data = { evaluatorName: document.getElementById('evaluatorName').value.trim(), evalDate: document.getElementById('evalDate').value, location: document.getElementById('location').value.trim(), activity: document.getElementById('activity').value.trim() };
                    
                    let highestRiskScore = 0; const evaluatedFactors = [];
                    document.querySelectorAll('#fase2 [id^="row-"]').forEach(r => { 
                        const s = parseInt(r.dataset.score, 10); 
                        const p = parseInt(r.dataset.prob, 10);
                        if (s > highestRiskScore) highestRiskScore = s; 
                        const f = r.id.split('-')[1]; 
                        evaluatedFactors.push({ 
                            id: f, 
                            text: document.getElementById(`text-${f}`).textContent, 
                            score: s, 
                            prob: p,
                            dimension: r.dataset.dimension 
                        }); 
                    });
                    const oC = getRiskClassification(highestRiskScore);
                    const assessmentData = { fase1: fase1Data, fase2: { ...fase2Data, factors: evaluatedFactors, overallRiskLevel: oC.level, overallRecommendation: oC.recommendation }, userId, createdAt: serverTimestamp() };
                    try { 
                        await addDoc(collection(db, `artifacts/${appId_str}/public/data/assessments`), assessmentData); 
                        showNotification("Avaliação guardada com sucesso!"); 
                        clearForm();
                    } catch (e) { 
                        console.error(e); 
                        showNotification("Erro ao guardar a avaliação.", true); 
                    }
                }

                const clearForm = () => { 
                    document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]').forEach(i=>i.value=''); 
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); 
                    document.getElementById('evalDate').valueAsDate = new Date(); 
                    document.getElementById('preliminaryDate').valueAsDate = new Date(); 
                    document.querySelectorAll('.risk-matrix').forEach(m => {
                        const f = m.dataset.factorId;
                        const d = m.querySelector('[data-score="1"]'); 
                        m.querySelector('.selected')?.classList.remove('selected'); 
                        d?.classList.add('selected'); 
                        const row = document.getElementById(`row-${f}`);
                        row.dataset.score = 1;
                        row.dataset.prob = 1;
                        updateFactorDisplay(f, 1);
                    }); 
                    document.getElementById('results-content-assessment').classList.add('hidden'); 
                };
                
                const updateAssessmentSummaryChart = (dRC) => {
                    const ctx=document.getElementById('assessment-summary-chart').getContext('2d'), l=Object.keys(dRC), r=["Risco Baixo","Risco Moderado","Risco Elevado","Risco Extremo"], c=['#22c55e','#facc15','#f97316','#ef4444'];
                    const d=r.map((L,i)=>({label:L,data:l.map(dim=>dRC[dim][L]),backgroundColor:c[i]}));
                    if(assessmentSummaryChart) assessmentSummaryChart.destroy();
                    assessmentSummaryChart=new Chart(ctx,{type:'bar',data:{labels:l,datasets:d},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true,ticks:{stepSize:1}}},plugins:{legend:{position:'bottom'}}}});
                };

                const updateAnalysisChart = (fD) => {
                    const ctx=document.getElementById('analysis-chart').getContext('2d'), rC={"Risco Baixo":0,"Risco Moderado":0,"Risco Elevado":0,"Risco Extremo":0};
                    fD.forEach(a => a.fase2?.factors?.forEach(f => rC[getRiskClassification(f.score).level]++));
                    if(analysisChart) analysisChart.destroy();
                    analysisChart=new Chart(ctx,{type:'bar',data:{labels:Object.keys(rC),datasets:[{label:'Nº Total de Fatores por Nível de Risco',data:Object.values(rC),backgroundColor:['#22c55e','#facc15','#f97316','#ef4444']}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{stepSize:1}}},plugins:{legend:{display:false}}}});
                };

                const loadAssessments = () => { onSnapshot(query(collection(db,`artifacts/${appId_str}/public/data/assessments`),orderBy("createdAt","desc")), (s)=>{allAssessments=[]; s.forEach(d=>allAssessments.push({id:d.id,...d.data()})); applyFilters();}, e => console.error("Firestore listener error: ", e)); };
                
                const applyFilters = () => {
                    const sD=document.getElementById('filter-start-date').value, eD=document.getElementById('filter-end-date').value, l=document.getElementById('filter-location').value.toLowerCase(), e=document.getElementById('filter-evaluator').value.toLowerCase();
                    filteredAssessments=allAssessments.filter(i=>{ 
                        const evalDate = i.createdAt?.toDate ? i.createdAt.toDate().toISOString().split('T')[0] : i.fase2?.evalDate || '';
                        const loc=i.fase2?.location||'', evN=i.fase2?.evaluatorName||''; 
                        return(!sD||evalDate>=sD)&&(!eD||evalDate<=eD)&&(!l||loc.toLowerCase().includes(l))&&(!e||evN.toLowerCase().includes(e));
                    });
                    renderHistoryList(filteredAssessments); updateAnalysisChart(filteredAssessments);
                };

                const renderHistoryList = (a) => {
                    const hE=document.getElementById('assessment-history-list'); if(a.length===0){hE.innerHTML='<p>Nenhuma avaliação encontrada.</p>'; return;}
                    hE.innerHTML=a.map(i=>{ 
                        if (!i.fase2) return ''; 
                        const oRL = i.fase2.overallRiskLevel || 'N/A'; 
                        const riskScoreMap = { "Risco Baixo": 1, "Risco Moderado": 4, "Risco Elevado": 8, "Risco Extremo": 15 }; 
                        const cl=getRiskClassification(riskScoreMap[oRL] || 1); 
                        const bg=cl.colorClass.replace('risk-','bg-');
                        const displayDate = i.createdAt?.toDate ? i.createdAt.toDate().toLocaleDateString() : (i.fase2.evalDate ? new Date(i.fase2.evalDate + 'T00:00:00').toLocaleDateString() : 'Sem data');
                        return `<div class="border rounded-lg p-4 flex justify-between items-center"><div><p class="font-bold">${i.fase2.activity || 'Atividade não especificada'} em ${i.fase2.location || 'Local não especificado'}</p><p class="text-sm text-gray-600">Avaliador: ${i.fase2.evaluatorName || 'N/A'} em ${displayDate}</p></div><div class="text-right"><span class="px-3 py-1 text-sm font-semibold text-white ${bg} rounded-full">${oRL}</span></div></div>`;
                    }).join('');
                };
                
                const exportSingleExcel = () => {
                    if (document.getElementById('results-content-assessment').classList.contains('hidden')) return showNotification("Calcule os resultados antes de exportar.", true);
                    
                    const wb = XLSX.utils.book_new();

                    // --- 1. Resumo Sheet ---
                    const gIF1 = { "Empresa/Instituição": document.getElementById('companyName').value, "Data Análise": document.getElementById('preliminaryDate').value, "Nome do Técnico": document.getElementById('technicianName').value, "Idade": document.getElementById('technicianAge').value };
                    const gIF2 = { Avaliador: document.getElementById('evaluatorName').value, "Data Avaliação": document.getElementById('evalDate').value, Local: document.getElementById('location').value, Atividade: document.getElementById('activity').value };
                    const oR = { "Nível de Risco Geral": document.getElementById('overall-result').querySelector('p').textContent, "Recomendação": document.getElementById('overall-result').querySelector('span').textContent };

                    const summaryData = [
                        ["Relatório de Análise de Risco"],
                        [], // Spacer
                        ["Fase 1 - Informações Gerais"],
                        ["Empresa/Instituição", gIF1["Empresa/Instituição"]],
                        ["Data Análise", gIF1["Data Análise"]],
                        ["Nome do Técnico", gIF1["Nome do Técnico"]],
                        ["Idade", gIF1["Idade"]],
                        [],
                        ["Fase 2 - Informações da Avaliação"],
                        ["Avaliador", gIF2.Avaliador],
                        ["Data Avaliação", gIF2["Data Avaliação"]],
                        ["Local", gIF2.Local],
                        ["Atividade", gIF2.Atividade],
                        [],
                        ["Resultado Geral"],
                        ["Nível de Risco Geral", oR["Nível de Risco Geral"]],
                        ["Recomendação", oR["Recomendação"]]
                    ];
                    const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                    summarySheet['!cols'] = [{wch: 30}, {wch: 50}]; // Set column widths
                    XLSX.utils.book_append_sheet(wb, summarySheet, "Resumo");

                    // --- 2. Medidas de Segurança Sheet ---
                    const medidasData = Array.from(document.querySelectorAll('#fase1 input[data-measure-text]:checked'))
                        .map(cb => ({ 'Medida de Segurança Verificada': cb.dataset.measureText }));
                    if (medidasData.length > 0) {
                        const medidasSheet = XLSX.utils.json_to_sheet(medidasData);
                        medidasSheet['!cols'] = [{wch: 100}];
                        XLSX.utils.book_append_sheet(wb, medidasSheet, "Medidas Segurança");
                    }

                    // --- 3. Material de Emergência Sheet ---
                    const materialData = Array.from(document.querySelectorAll('#fase1 input[data-material-text]:checked'))
                        .map(cb => ({ 'Categoria': cb.dataset.materialCategory, 'Item Verificado': cb.dataset.materialText }));
                    if (materialData.length > 0) {
                        const materialSheet = XLSX.utils.json_to_sheet(materialData);
                        materialSheet['!cols'] = [{wch: 30}, {wch: 70}];
                        XLSX.utils.book_append_sheet(wb, materialSheet, "Material Emergência");
                    }

                    // --- 4. Fatores de Risco Sheet ---
                    const f2D = []; 
                    document.querySelectorAll('#fase2 [id^="row-"]').forEach(r => { 
                        const f = r.id.split('-')[1]; 
                        f2D.push({ 
                            'Dimensão': r.dataset.dimension, 
                            'Fator de Risco': document.getElementById(`text-${f}`).textContent, 
                            'Score': parseInt(r.dataset.score),
                            'Nível': getRiskClassification(parseInt(r.dataset.score)).level 
                        }); 
                    });
                    const f2Sheet = XLSX.utils.json_to_sheet(f2D);
                    f2Sheet['!cols'] = [{wch: 25}, {wch: 80}, {wch: 10}, {wch: 20}];
                    XLSX.utils.book_append_sheet(wb, f2Sheet, "Fatores de Risco");

                    XLSX.writeFile(wb, `Relatorio_Completo_${gIF2["Data Avaliação"] || 'single'}.xlsx`);
                };

                const exportPhase1Excel = () => {
                    const wb = XLSX.utils.book_new();

                    // --- 1. Resumo Sheet ---
                    const gIF1 = { "Empresa/Instituição": document.getElementById('companyName').value, "Data": document.getElementById('preliminaryDate').value, "Técnico": document.getElementById('technicianName').value, "Idade": document.getElementById('technicianAge').value };
                    const summaryData = [
                        ["Análise Preliminar"],
                        [],
                        ["Informações Gerais"],
                        ["Empresa/Instituição", gIF1["Empresa/Instituição"]],
                        ["Data", gIF1.Data],
                        ["Técnico", gIF1.Técnico],
                        ["Idade", gIF1.Idade]
                    ];
                    const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                    summarySheet['!cols'] = [{wch: 30}, {wch: 50}];
                    XLSX.utils.book_append_sheet(wb, summarySheet, "Resumo");
                    
                    // --- 2. Medidas de Segurança Sheet ---
                    const medidasData = Array.from(document.querySelectorAll('#fase1 input[data-measure-text]:checked'))
                        .map(cb => ({ 'Medida de Segurança Verificada': cb.dataset.measureText }));
                    if (medidasData.length > 0) {
                        const medidasSheet = XLSX.utils.json_to_sheet(medidasData);
                        medidasSheet['!cols'] = [{wch: 100}];
                        XLSX.utils.book_append_sheet(wb, medidasSheet, "Medidas Segurança");
                    }

                    // --- 3. Material de Emergência Sheet ---
                    const materialData = Array.from(document.querySelectorAll('#fase1 input[data-material-text]:checked'))
                        .map(cb => ({ 'Categoria': cb.dataset.materialCategory, 'Item Verificado': cb.dataset.materialText }));
                    if (materialData.length > 0) {
                        const materialSheet = XLSX.utils.json_to_sheet(materialData);
                        materialSheet['!cols'] = [{wch: 30}, {wch: 70}];
                        XLSX.utils.book_append_sheet(wb, materialSheet, "Material Emergência");
                    }

                    XLSX.writeFile(wb, `Analise_Preliminar_${document.getElementById('preliminaryDate').value || 'report'}.xlsx`);
                };

                const exportFilteredExcel = () => {
                    if (filteredAssessments.length === 0) return showNotification("Nenhum dado filtrado para exportar.", true);
                    
                    const wb = XLSX.utils.book_new();

                    // --- Resumo Sheet ---
                    const sumD = filteredAssessments.map(i => ({
                        'Data': i.createdAt?.toDate ? i.createdAt.toDate().toLocaleDateString() : (i.fase2.evalDate ? new Date(i.fase2.evalDate + 'T00:00:00').toLocaleDateString() : 'Sem data'),
                        'Avaliador': i.fase2.evaluatorName,
                        'Local': i.fase2.location,
                        'Atividade': i.fase2.activity,
                        'Nível Risco': i.fase2.overallRiskLevel,
                        'Recomendação': i.fase2.overallRecommendation
                    }));
                    const summarySheet = XLSX.utils.json_to_sheet(sumD);
                    summarySheet['!cols'] = [{wch: 12}, {wch: 25}, {wch: 30}, {wch: 30}, {wch: 15}, {wch: 20}];
                    XLSX.utils.book_append_sheet(wb, summarySheet, "Resumo Filtrado");
                    
                    // --- Detalhes Sheet ---
                    const detD = []; 
                    filteredAssessments.forEach((i, idx) => {
                        (i.fase2.factors || []).forEach(f => {
                            detD.push({
                                'ID Avaliação': idx + 1,
                                'Data': i.createdAt?.toDate ? i.createdAt.toDate().toLocaleDateString() : (i.fase2.evalDate ? new Date(i.fase2.evalDate + 'T00:00:00').toLocaleDateString() : 'Sem data'),
                                'Avaliador': i.fase2.evaluatorName,
                                'Dimensão': f.dimension,
                                'Fator': f.text,
                                'Score': f.score,
                                'Nível': getRiskClassification(f.score).level
                            });
                        });
                    });
                    const detailsSheet = XLSX.utils.json_to_sheet(detD);
                    detailsSheet['!cols'] = [{wch: 12}, {wch: 12}, {wch: 25}, {wch: 25}, {wch: 80}, {wch: 10}, {wch: 20}];
                    XLSX.utils.book_append_sheet(wb, detailsSheet, "Dados Completos Filtrados");
                    
                    XLSX.writeFile(wb, `Export_Filtrado_${new Date().toISOString().slice(0,10)}.xlsx`);
                };

                const exportPdf = (selector) => {
                    const element = document.querySelector(selector);
                    if (!element) return;
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({orientation: "p", unit: "mm", format: "a4"});
                    html2canvas(element, { scale: 2 }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdfWidth = doc.internal.pageSize.getWidth();
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                        let heightLeft = pdfHeight;
                        let position = 0;
                        doc.addImage(imgData, 'PNG', 10, position, pdfWidth - 20, pdfHeight);
                        heightLeft -= doc.internal.pageSize.getHeight();
                        while (heightLeft >= 0) {
                            position = heightLeft - pdfHeight;
                            doc.addPage();
                            doc.addImage(imgData, 'PNG', 10, position, pdfWidth - 20, pdfHeight);
                            heightLeft -= doc.internal.pageSize.getHeight();
                        }
                        doc.save(`Relatorio_${selector.replace('#','')}_${new Date().toISOString().slice(0,10)}.pdf`);
                    });
                };

                document.getElementById('tab-fase1').onclick = () => changeTab('fase1');
                document.getElementById('tab-fase2').onclick = () => changeTab('fase2');
                document.getElementById('tab-fase3').onclick = () => changeTab('fase3');
                
                renderFase1();
                renderFase2();
                renderFase3();

                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';

            } catch (error) {
                console.error("Erro Crítico na Inicialização:", error);
                const loading = document.getElementById('loading-overlay');
                if(loading) loading.remove();
                document.body.innerHTML = `<div class="p-8 text-center bg-red-100 text-red-800"><h1>Ocorreu um Erro na Aplicação</h1><p>A aplicação não conseguiu carregar. Por favor, verifique a consola para mais detalhes.</p><p class="mt-2 text-sm text-gray-600">${error.message}</p></div>`;
            }
        }
        
        // Run the main function after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>

